{% extends 'base.html' %}
{% block content %}
<h2 class="title is-3">Google-Sheet Einstellungen</h2>

<div class="columns">
    <div class="column is-one-third">
        <div class="box">
            <form id="gsheetForm">
                <div class="field">
                    <label class="label">Sheet-ID</label>
                    <div class="control">
                        <input class="input" type="text" id="sheet_id" placeholder="1abcDEF…">
                    </div>
                </div>
                <div class="field">
                    <label class="label">Worksheet-Name (optional)</label>
                    <div class="control">
                        <input class="input" type="text" id="worksheet_name" placeholder="Sheet1">
                    </div>
                </div>
                <div class="field is-grouped">
                    <div class="control">
                        <button class="button is-primary" type="submit">Speichern</button>
                    </div>
                    <div class="control">
                        <button id="reload" class="button is-link is-light" type="button">Neu laden</button>
                    </div>
                </div>
                <p class="help">Service-Account JSON wird serverseitig über <code>GOOGLE_CREDENTIALS_PATH</code>
                    gesetzt.</p>
            </form>
        </div>
    </div>
    <div class="column">
        <div id="sheet_container" style="overflow:auto; max-height:75vh;"></div>
    </div>
</div>

<script>
    (function () {
        const cfg = JSON.parse('{{ sheet_cfg | tojson | safe }}');
        if (cfg) {
            document.getElementById('sheet_id').value = cfg.sheet_id || '';
            document.getElementById('worksheet_name').value = cfg.worksheet_name || '';
        }

        async function loadPreview() {
            const cont = document.getElementById('sheet_container');
            cont.innerHTML = '<p>Lade…</p>';
            const resp = await fetch(`/guilds/{{ guild_id }}/google-sheet/preview`);
            if (!resp.ok) {
                cont.innerHTML = '<p class="has-text-danger">Fehler beim Abrufen: ' + resp.statusText + '</p>';
                return;
            }
            const data = await resp.json();
            const rows = data.values || [];
            if (rows.length === 0) {
                cont.innerHTML = '<p>Keine Daten vorhanden.</p>';
                return;
            }
            const maxCols = Math.max(...rows.map(r => r.length));
            const colLetter = n => { let s = ''; while (n >= 0) { s = String.fromCharCode((n % 26) + 65) + s; n = Math.floor(n / 26) - 1; } return s; };
            let html = '<table class="table is-fullwidth sheet-preview"><thead><tr><th></th>';
            for (let c = 0; c < maxCols; c++) { html += `<th>${colLetter(c)}</th>`; }
            html += '</tr></thead><tbody>';
            rows.forEach((row, idx) => {
                html += `<tr><th>${idx + 1}</th>`;
                for (let c = 0; c < maxCols; c++) { const val = row[c] ?? ''; html += `<td>${val}</td>`; }
                html += '</tr>';
            });
            html += '</tbody></table>';

            // Apply existing mapping highlight
            if (cfg.username_mapping) {
                const { row: mRow, col: mCol, direction: dir } = cfg.username_mapping;
                const wrap = document.createElement('div');
                wrap.innerHTML = html;
                const tableEl = wrap.firstChild;
                if (dir === 'vertical') {
                    tableEl.querySelectorAll('tbody tr').forEach((tr, idx) => {
                        if (idx < mRow) return; // start mapping from anchor row downward
                        const td = tr.children[mCol + 1];
                        if (td) td.classList.add('cell-mapped');
                    });
                } else {
                    const targetTr = tableEl.querySelectorAll('tbody tr')[mRow];
                    if (targetTr) {
                        targetTr.querySelectorAll('td').forEach((td, idx) => {
                            if (idx < mCol) return; // start from anchor col
                            td.classList.add('cell-mapped');
                        });
                    }
                }
                // highlight anchor cell stronger
                const anchorTd = tableEl.querySelectorAll('tbody tr')[mRow]?.children[mCol + 1];
                if (anchorTd) anchorTd.classList.add('cell-anchor');

                html = tableEl.outerHTML;
            }

            cont.innerHTML = html;
        }

        loadPreview();
        document.getElementById('reload').addEventListener('click', loadPreview);

        document.getElementById('gsheetForm').addEventListener('submit', async e => {
            e.preventDefault();
            const payload = {
                sheet_id: document.getElementById('sheet_id').value.trim(),
                worksheet_name: document.getElementById('worksheet_name').value.trim()
            };
            await fetch(`/guilds/{{ guild_id }}/google-sheet`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            alert('Gespeichert');
            loadPreview();
        });

        // ----- Context menu for mapping -----------------------------
        let ctxMenu;
        function createMenu(x, y, cellRow, cellCol) {
            if (ctxMenu) ctxMenu.remove();
            ctxMenu = document.createElement('div');
            ctxMenu.className = 'sheet-context dropdown-content';
            ctxMenu.style.left = x + 'px';
            ctxMenu.style.top = y + 'px';
            ctxMenu.innerHTML = `
                <a class="dropdown-item" data-dir="vertical">Als Nutzernamen (↓ vertikal)</a>
                <a class="dropdown-item" data-dir="horizontal">Als Nutzernamen (→ horizontal)</a>`;
            document.body.appendChild(ctxMenu);
            ctxMenu.querySelectorAll('a').forEach(a => {
                a.addEventListener('click', async () => {
                    const dir = a.dataset.dir;
                    if (ctxMenu) ctxMenu.remove();
                    await fetch(`/guilds/{{ guild_id }}/google-sheet/username-mapping`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ row: cellRow, col: cellCol, direction: dir })
                    });
                    alert('Mapping gespeichert');
                    location.reload();
                });
            });
        }
        document.addEventListener('contextmenu', e => {
            if (!e.target.closest('#sheet_container td')) return;
            e.preventDefault();
            const td = e.target.closest('td');
            const tr = td.parentElement;
            const col = Array.from(tr.children).indexOf(td) - 1; // minus row header
            const row = Array.from(tr.parentElement.children).indexOf(tr);
            createMenu(e.pageX, e.pageY, row, col);
        });
        document.addEventListener('click', () => { if (ctxMenu) ctxMenu.remove(); });
    })();
</script>
{% endblock %}
